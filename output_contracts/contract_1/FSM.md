**Curve Finance æµåŠ¨æ€§æä¾› Zap-in äº¤æ˜“åˆçº¦** çš„åŠŸèƒ½å’Œé€»è¾‘ï¼Œå°†å…¶æŠ½è±¡ä¸ºå›¾ç‰‡ä¸­å®šä¹‰çš„ **æœ‰é™çŠ¶æ€æœº (Finite State Machine, FSM)** å½¢å¼ $$(S, s_0, C, I, O, \to)$$.

---

## ğŸ”— åˆçº¦ FSM æŠ½è±¡ (Smart Contract FSM Abstraction)

### 1. çŠ¶æ€é›† $S$ å’Œåˆå§‹çŠ¶æ€ $s_0$

* **çŠ¶æ€é›† $S$:**
    * $s_0$: **Idle (ç©ºé—²)** - åˆçº¦å·²éƒ¨ç½²ä½†å°šæœªå¼€å§‹äº¤æ˜“æˆ–æ­£åœ¨ç­‰å¾…æ–°çš„ Zap-in è°ƒç”¨ã€‚
    * $s_1$: **Token Approval/Allowance Check (ä»£å¸æˆæƒ/é¢åº¦æ£€æŸ¥)** - æ­£åœ¨æ‰§è¡Œ `approveToken` å‡½æ•°æˆ–åœ¨ Zap-in æµç¨‹ä¸­æ£€æŸ¥ç”¨æˆ·ä»£å¸æˆæƒã€‚
    * $s_2$: **Zap-in Processing (Zap-in äº¤æ˜“å¤„ç†ä¸­)** - æ­£åœ¨æ‰§è¡Œ `ZapIn` ç³»åˆ—å‡½æ•°ï¼ˆå¦‚ä»£å¸å…‘æ¢ã€è·¯å¾„æŸ¥æ‰¾ç­‰ï¼‰ã€‚
    * $s_3$: **Liquidity Provision (æµåŠ¨æ€§æä¾›)** - æ­£åœ¨å°†èµ„äº§å­˜å…¥é€‰å®šçš„ Curve æ± ã€‚
    * $s_4$: **Transaction Finalized (äº¤æ˜“å®Œæˆ)** - æµåŠ¨æ€§å·²æ·»åŠ ï¼Œæ± ä»£å¸å·²è¿”å›ç»™ç”¨æˆ·ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªäº¤æ˜“ã€‚
    * $s_{\text{stop}}$: **Stopped/Paused (åœæ­¢/æš‚åœ)** - åˆçº¦å› ç®¡ç†å‘˜æ“ä½œï¼ˆ`stopped` å˜é‡æ¿€æ´»ï¼‰è€Œæš‚åœã€‚
* **åˆå§‹çŠ¶æ€ $s_0$:** $\text{Idle (ç©ºé—²)}$

---

### 2. å˜é‡é›† $C, I, O$

è¿™ä¸‰ä¸ªé›†åˆæ˜¯**ä¸ç›¸äº¤**çš„ï¼Œåˆ†åˆ«ä»£è¡¨**åˆçº¦å˜é‡**ã€**è¾“å…¥å˜é‡**å’Œ**è¾“å‡ºå˜é‡**ã€‚

* **åˆçº¦å˜é‡é›† $C$ (Contract Variables):** å­˜å‚¨åœ¨åˆçº¦ä¸­çš„çŠ¶æ€å˜é‡ã€‚
    * **Goodwill:** ä»£è¡¨æŸç§å¥–åŠ±æˆ–é¢å¤–ä»£å¸çš„å˜é‡ã€‚
    * **Stopped:** å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºåˆçº¦æ˜¯å¦æš‚åœã€‚
    * **Exchange2Token:** æ˜ å°„æˆ–åœ°å€ï¼Œç”¨äºä»£å¸å…‘æ¢é€»è¾‘ã€‚
    * **å„ç§ Token Addresses:** ä¾‹å¦‚ Curve æ± åœ°å€ã€è¾“å…¥ä»£å¸åœ°å€ç­‰ã€‚
* **è¾“å…¥å˜é‡é›† $I$ (Input Variables):** ç”¨æˆ·è°ƒç”¨å‡½æ•°æ—¶æä¾›çš„å‚æ•°ã€‚
    * **User/Sender:** äº¤æ˜“å‘èµ·è€…åœ°å€ã€‚
    * **`inToken`:** è¾“å…¥ä»£å¸çš„åœ°å€ï¼ˆå¯¹äº `ZapInWithERC20`ï¼‰ã€‚
    * **`_amount`:** è¾“å…¥çš„ä»£å¸æ•°é‡æˆ– ETH æ•°é‡ã€‚
    * **`_toPool`:** ç›®æ ‡ Curve æ± çš„åœ°å€ã€‚
    * **`_min_liquidity`:** æœŸæœ›è·å¾—çš„æœ€å°æµåŠ¨æ€§ä»£å¸æ•°é‡ï¼ˆæ»‘ç‚¹æ§åˆ¶ï¼‰ã€‚
    * **`token_to_approve`:** éœ€è¦æˆæƒçš„ä»£å¸åœ°å€ï¼ˆå¯¹äº `approveToken`ï¼‰ã€‚
* **è¾“å‡ºå˜é‡é›† $O$ (Output Variables):** äº¤æ˜“æ‰§è¡Œåè¿”å›ç»™ç”¨æˆ·çš„å€¼æˆ–çŠ¶æ€å˜åŒ–ã€‚
    * **Pool Tokens Received:** äº¤æ˜“æˆåŠŸåç”¨æˆ·è·å¾—çš„ Curve æ± ä»£å¸æ•°é‡ã€‚
    * **Gas Used:** äº¤æ˜“æ¶ˆè€—çš„ Gas é‡ã€‚
    * **Transaction Status (Success/Fail):** äº¤æ˜“ç»“æœã€‚

---

### 3. è½¬æ¢å…³ç³» $\to \subseteq S \times \mathcal{G} \times \mathcal{F} \times S$

è½¬æ¢å…³ç³» ($\to$) ç”±ä¸€ä¸ª **Guard ($\mathcal{G}$, å®ˆå«)** å’Œä¸€ä¸ª **Action ($\mathcal{F}$, åŠ¨ä½œ)** å†³å®šï¼Œä½¿å¾—çŠ¶æ€ä» $s_i$ è¿ç§»åˆ° $s_j$ã€‚

* **å®ˆå«é›† $\mathcal{G} = \mathbb{B}[C, I]$ (Guards):** ä¾èµ–äº**åˆçº¦**å’Œ**è¾“å…¥**å˜é‡çš„å¸ƒå°”è¡¨è¾¾å¼ã€‚

| Guard ($\mathcal{G}$) | æè¿° |
| :--- | :--- |
| $\mathbf{G}_1$ | **`_amount` $> 0$** ä¸” **`stopped` $==$ false** |
| $\mathbf{G}_2$ | **`stopped` $==$ false** ä¸” **æˆæƒé¢åº¦ $\ge$ `_amount`** |
| $\mathbf{G}_3$ | **`stopped` $==$ false** ä¸” **`inToken` $==$ ETH** |
| $\mathbf{G}_4$ | **æµåŠ¨æ€§æ·»åŠ æˆåŠŸ** ä¸” **è·å¾—çš„æ± ä»£å¸ $\ge$ `_min_liquidity`** |
| $\mathbf{G}_5$ | **`stopped` $==$ true** |
| $\mathbf{G}_6$ | **`token_to_approve` $\neq$ é›¶åœ°å€** |

* **åŠ¨ä½œé›† $\mathcal{F}$ (Actions):** æ”¹å˜**åˆçº¦**ã€**è¾“å…¥**æˆ–**è¾“å‡º**å˜é‡çš„æ“ä½œã€‚

| Action ($\mathcal{F}$) | æè¿° |
| :--- | :--- |
| $\mathbf{F}_1$ | **è°ƒç”¨ `ZapInWithETH` æˆ– `ZapInWithERC20`** (å¼€å§‹ Zap æµç¨‹) |
| $\mathbf{F}_2$ | **è°ƒç”¨ `approveToken`** (æ›´æ–°æˆæƒé¢åº¦) |
| $\mathbf{F}_3$ | **æ‰§è¡Œä»£å¸å…‘æ¢ (Swap)** |
| $\mathbf{F}_4$ | **æ‰§è¡ŒæµåŠ¨æ€§æä¾›å‡½æ•°** (æ›´æ–° $C$ ä¸­çš„æ± ä»£å¸ä½™é¢) |
| $\mathbf{F}_5$ | **å°†è·å¾—çš„ Pool Tokens å‘é€ç»™ User** (æ›´æ–° $O$) |
| $\mathbf{F}_6$ | **Emit Event** (å¦‚åˆçº¦æš‚åœ/æ¿€æ´»äº‹ä»¶) |

* **çŠ¶æ€è½¬æ¢**

| æºçŠ¶æ€ ($S$) | ç›®æ ‡çŠ¶æ€ ($S$) | å®ˆå« ($\mathcal{G}$) | åŠ¨ä½œ ($\mathcal{F}$) | æè¿° (å‡½æ•°è°ƒç”¨) |
| :--- | :--- | :--- | :--- | :--- |
| $s_0$ (Idle) | $s_1$ (Approval) | $\mathbf{G}_6$ | $\mathbf{F}_2$ | ç”¨æˆ·è°ƒç”¨ `approveToken` |
| $s_0$ (Idle) | $s_2$ (Processing) | $\mathbf{G}_1$ and ($\mathbf{G}_2$ or $\mathbf{G}_3$) | $\mathbf{F}_1$ | ç”¨æˆ·è°ƒç”¨ `ZapIn` / `ZapInWithETH` / `ZapInWithERC20` |
| $s_1$ (Approval) | $s_0$ (Idle) | True | $\mathbf{F}_6$ | æˆæƒæˆåŠŸï¼Œå›åˆ°ç©ºé—²çŠ¶æ€ |
| $s_2$ (Processing) | $s_3$ (Provision) | $\mathbf{G}_1$ | $\mathbf{F}_3$ | æ‰§è¡Œå…‘æ¢ï¼Œå‡†å¤‡æä¾›æµåŠ¨æ€§ |
| $s_3$ (Provision) | $s_4$ (Finalized) | $\mathbf{G}_4$ | $\mathbf{F}_4, \mathbf{F}_5, \mathbf{F}_6$ | æä¾›æµåŠ¨æ€§æˆåŠŸå¹¶å‘é€æ± ä»£å¸ |
| $s_4$ (Finalized) | $s_0$ (Idle) | True | None | äº¤æ˜“å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè¾“å…¥ |
| $s_0/s_1/s_2/s_3/s_4$ | $s_{\text{stop}}$ (Stopped) | $\mathbf{G}_5$ (ç”±ç®¡ç†å‘˜è®¾ç½®) | $\mathbf{F}_6$ | åˆçº¦è¢«æš‚åœ |
| $s_{\text{stop}}$ (Stopped) | $s_0$ (Idle) | **`stopped` $==$ false** (ç”±ç®¡ç†å‘˜è®¾ç½®) | $\mathbf{F}_6$ | åˆçº¦è¢«æ¢å¤ |


---

**ä¸‹ä¸€æ­¥**ï¼Œæ‚¨æƒ³è®©æˆ‘è¯¦ç»†è§£é‡Š**å®ˆå«**æˆ–**åŠ¨ä½œ**çš„å…·ä½“ä»£ç é€»è¾‘å—ï¼Ÿ